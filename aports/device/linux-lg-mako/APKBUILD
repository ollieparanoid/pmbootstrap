# Kernel config based on: arch/arm/configs/mako_rob_defconfig

pkgname="linux-lg-mako"
pkgver=3.4.0
pkgrel=1
pkgdesc="Nexus 4 kernel from Freedreno"
arch="armhf"
_carch="arm"
_flavor="lg-mako"
url="https://github.com/LineageOS/lge-kernel-mako"
license="GPL2"
options="!strip !check !tracedeps"
makedepends="perl sed installkernel bash gmp-dev bc linux-headers elfutils-dev"
HOSTCC="${CC:-gcc}"
HOSTCC="${HOSTCC#${CROSS_COMPILE}}"

# Source (last commit of branch "mako-kernel")
_repository="kernel-msm"
_commit="54b510b2e6bccf08fdf3a8ad00a62b27c2f8c1e6"
_config="config-${_flavor}.armhf"
source="
	$pkgname-$_commit.tar.gz::https://github.com/freedreno/${_repository}/archive/${_commit}.tar.gz
	$_config
	compiler-gcc6.h
	00_fix_return_address.patch
	01_timeconst_fix.patch
"
builddir="$srcdir/${_repository}-${_commit}"

prepare() {
	default_prepare

	# gcc6 support
	cp -v "$srcdir/compiler-gcc6.h" "$builddir/include/linux/"

	cp "$srcdir"/$_config "$builddir"/.config
	make ARCH="$_carch" HOSTCC="$HOSTCC" silentoldconfig
}

menuconfig() {
	cd "$builddir"
	make ARCH="$_carch" menuconfig
	cp .config "$startdir"/$_config
}

build() {
	unset LDFLAGS
	make ARCH="$_carch" CC="${CC:-gcc}" \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-Alpine"
}

package() {
	install -Dm644 "$builddir/arch/arm/boot/zImage" \
		"$pkgdir/boot/vmlinuz-$_flavor"

	install -D "$builddir/include/config/kernel.release" \
		"$pkgdir/usr/share/kernel/$_flavor/kernel.release"
}

sha512sums="0b3d201b344bfe6a4823c0e3eb5bfbc93d614fa6280eee349a959e4e9479df40b5919e61c1acc6206984bd502c5e8f2979cad55589bef36dbb934d91242aa9e4  linux-lg-mako-54b510b2e6bccf08fdf3a8ad00a62b27c2f8c1e6.tar.gz
76916f0f1e67c26f383150b2d292e4dfc07215fddada57b3b6d66c02693ef5cf6b6d21d839be32e0bed51ee756fb315a3523c7838d768e3886dce9c6dde6cbcf  config-lg-mako.armhf
d80980e9474c82ba0ef1a6903b434d8bd1b092c40367ba543e72d2c119301c8b2d05265740e4104ca1ac5d15f6c4aa49e8776cb44264a9a28dc551e0d1850dcc  compiler-gcc6.h
ea1d3b5a234fa565e3c1a792de48f4fc4e6023d281d303c8e319c7ef28edc5739ab0e4dea0139a41f0a5c7d03e27921ccaa214fd0ac5c72245a094ce60128864  00_fix_return_address.patch
a2bb98fb8d988bbb659cae00fbaca360828300e9b98b90aed5ee0dd839c3f740696df4094a9021b813cbada06820d115aabed581a47cdd2c947e8d853c20b145  01_timeconst_fix.patch"
